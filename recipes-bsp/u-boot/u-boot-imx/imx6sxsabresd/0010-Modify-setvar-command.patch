From ce51e0ec78f1cb7014eb70acdda259ef655ce9d2 Mon Sep 17 00:00:00 2001
From: sathishkumar-rk <sathishkumar.k@jasmin-infotech.com>
Date: Thu, 26 Oct 2023 17:42:03 +0530
Subject: [PATCH] Modify setvar command

---
 cmd/mem_misc.c                 | 43 +++++++++++++++++-----------------
 include/configs/mx6sxsabresd.h |  2 +-
 2 files changed, 22 insertions(+), 23 deletions(-)

diff --git a/cmd/mem_misc.c b/cmd/mem_misc.c
index aca28bf580..db897d6620 100644
--- a/cmd/mem_misc.c
+++ b/cmd/mem_misc.c
@@ -1,39 +1,26 @@
-#include <common.h>
-#include <console.h>
-#include <bootretry.h>
-#include <cli.h>
+
+#include <command.h>
 #include <command.h>
-#include <console.h>
-#include <flash.h>
-#include <hash.h>
-#include <log.h>
-#include <mapmem.h>
-#include <rand.h>
-#include <watchdog.h>
-#include <asm/global_data.h>
-#include <asm/io.h>
-#include <linux/bitops.h>
-#include <linux/compiler.h>
-#include <linux/ctype.h>
-#include <linux/delay.h>
 
 static int do_mem_misc_setvar(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
 {
 	ulong addr;
 	ulong size;
+	ulong endianess;
 	int i;
 	uchar data[32];
 	char hex_data[80];
 
-	if (argc != 4)
+	if (argc != 5)
 	{
-		printf("Usage: %s <variable> <address> <size>\n", argv[0]);
+		printf("Usage: %s <variable> <address> <size> <rev>\n", argv[0]);
 		return CMD_RET_USAGE;
 	}
 
 	char *var_name = argv[1];
 	addr = simple_strtoul(argv[2], NULL, 16);
 	size = simple_strtoul(argv[3], NULL, 16);
+	endianess = simple_strtoul(argv[4], NULL, 16);
 
 	if (size <= 0 || size > 32)
 	{
@@ -48,9 +35,21 @@ static int do_mem_misc_setvar(struct cmd_tbl *cmdtp, int flag, int argc, char *c
 	}
 
 	// Read & copy data from memory
-	for (i = 0; i < size; i++)
+	if (endianess == 0) 
+	{
+		for (i = 0; i < size; i++)
+		{
+			data[i] = *(uchar *)(addr + i);
+		}
+	} 
+	else if (endianess >= 1)
 	{
-		data[i] = *(uchar *)(addr + i);
+		int j = 0;
+		for (i = size - 1; i >= 0; i--) 
+		{
+			data[j] = *(uchar *)(addr + i);
+			j++;
+		}
 	}
 
 	// Convert binary to hexadecimal string
@@ -68,6 +67,6 @@ static int do_mem_misc_setvar(struct cmd_tbl *cmdtp, int flag, int argc, char *c
 
 /**************************************************/
 U_BOOT_CMD(
-	setvar, 4, 1, do_mem_misc_setvar,
+	setvar, 5, 1, do_mem_misc_setvar,
 	"Read memory content and store it in an environment variable passed",
 	"<variable> <address> <size>");
diff --git a/include/configs/mx6sxsabresd.h b/include/configs/mx6sxsabresd.h
index 485158b43e..549e36eb93 100644
--- a/include/configs/mx6sxsabresd.h
+++ b/include/configs/mx6sxsabresd.h
@@ -133,7 +133,7 @@
 			"echo \"Open board - HAB authenticate key file \"; " \
                         "hab_auth_img ${hash_addr} ${filesize} 1000 ;" \
 		"fi;" \
-		"setvar hash ${hash_addr} 20;" \
+		"setvar hash ${hash_addr} 20 0;" \
 		"run mmcargs; " \
 		"run loadimage; " \
 		"run loadfdt; " \
